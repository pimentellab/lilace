<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Introduction to Lilace â€¢ lilace</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Lilace"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">lilace</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/intro.html">Introduction to Lilace</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jermoef/lilace/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to Lilace</h1>
                        <h4 data-toc-skip class="author">Jerome
Freudenberg</h4>
            
            <h4 data-toc-skip class="date">June 25 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jermoef/lilace/blob/HEAD/vignettes/intro.Rmd" class="external-link"><code>vignettes/intro.Rmd</code></a></small>
      <div class="d-none name"><code>intro.Rmd</code></div>
    </div>

    
    
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Lilace is a tool for scoring FACS-based DMS experiments with
uncertainty quantification. It takes in a negative control group
(usually synonymous variants) and scores each variant relative to the
negative control group.</p>
<p>The standard workflow is:</p>
<ol style="list-style-type: decimal">
<li>Import data into Lilace format</li>
<li>Normalize to cell sorting percentages (if available)</li>
<li>Run Lilace. On a full length protein, Lilace usually takes a few
hours to run (see paper supplement for more details)</li>
<li>Analyze Lilace output</li>
</ol>
<p>This notebook shows an example run of Lilace from installation to
analysis on a toy dataset. We provide functions to load counts into
Lilaceâ€™s input format (step 1), normalize counts to cell sorting
proportions (step 2), run Lilace (step 3), and plot the results (step
4). By default, Lilace incorporates variance in the negative control
scores into effect size uncertainty (standard errors) and makes use of
similar effects at a position to improve estimation. Both of these
behaviors can optionally be turned off when running Lilace.</p>
</div>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>Lilace is built using <code>stan</code> and interacts with
<code>CmdStan</code> using the package <code>cmdstanr</code>. This
requires C++ compilation. The compiler requirements can be seen at <a
href="https://github.com/stan-dev/stan/wiki/Coding-Style-and-Idioms#supported-cpp-versions-and-compilers">stan-dev</a>.
If you run into issues with installation, please ensure your gcc version
is &gt; 5.</p>
<p>First, we install <code>cmdstanr</code>. We recommend running this in
a fresh R session or restarting your current session.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;cmdstanr&quot;</span>, <span class="at">repos =</span> <span class="fu">c</span>(<span class="st">&#39;https://stan-dev.r-universe.dev&#39;</span>, <span class="fu">getOption</span>(<span class="st">&quot;repos&quot;</span>)))</span></code></pre></div>
<p>Then, we use <code>cmdstanr</code> to install <code>CmdStan</code>.
This requires a working C++ toolchain and compiler.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">install_cmdstan</span>(<span class="at">cores =</span> <span class="dv">2</span>) <span class="co"># number of cores to use for installation</span></span></code></pre></div>
<p>We can check the <code>CmdStan</code> version to verify correct
installation.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">cmdstan_version</span>()</span></code></pre></div>
<p>Now, we can install Lilace from github.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">&quot;remotes&quot;</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">&quot;remotes&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;pimentellab/lilace&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">library</span>(lilace)</span></code></pre></div>
</div>
<div id="load-input-data" class="section level2">
<h2>Load input data</h2>
<p>Next, we load in the toy dataset, which includes the first 20
positions of a GPR68 screen from (<a
href="https://www.cell.com/cell/fulltext/S0092-8674(24)01373-4"
class="uri">https://www.cell.com/cell/fulltext/S0092-8674(24)01373-4</a>).
This data is provided with a standard installation of Lilace.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;gpr68_ph55_20pos.RData&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>))</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">head</span>(dataset)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 14[39m
##   hgvs_exp  hgvs  position wildtype mutation type    c_0   c_1   c_2   c_3 exp  
##   [3m[38;5;246m&lt;chr&gt;[39m[23m     [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m
## [38;5;250m1[39m p.(G2A)_â€¦ p.(Gâ€¦        2 G        A        missâ€¦   118   146   215   260 ph55 
## [38;5;250m2[39m p.(G2A)_â€¦ p.(Gâ€¦        2 G        A        missâ€¦   146   108   127   284 ph55 
## [38;5;250m3[39m p.(G2A)_â€¦ p.(Gâ€¦        2 G        A        missâ€¦   144    55   106   134 ph55 
## [38;5;250m4[39m p.(G2C)_â€¦ p.(Gâ€¦        2 G        C        missâ€¦   148   101   384   507 ph55 
## [38;5;250m5[39m p.(G2C)_â€¦ p.(Gâ€¦        2 G        C        missâ€¦   203   201   307   616 ph55 
## [38;5;250m6[39m p.(G2C)_â€¦ p.(Gâ€¦        2 G        C        missâ€¦   236   175   262   547 ph55 
## [38;5;246m# â„¹ 3 more variables: rep &lt;chr&gt;, n_counts &lt;dbl&gt;, total_counts &lt;dbl&gt;[39m</code></pre>
<p>We then put the data into a Lilace object using the
<code>lilace_from_counts()</code> function, which requires:</p>
<ol style="list-style-type: decimal">
<li>variant identifier (e.g.Â hgvs), ensure this is unique for each
variant</li>
<li>mutation type (e.g.Â synonymous, missense)â€“this will be used to
identify the negative controls</li>
<li>residue position</li>
<li>replicate information</li>
<li>the FACS bin counts</li>
<li>any metadata you wish to carry over into the final output.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># load from components</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>lilace_obj <span class="ot">&lt;-</span> <span class="fu">lilace_from_counts</span>(<span class="at">variant_id=</span>dataset<span class="sc">$</span>hgvs, <span class="at">mutation_type=</span>dataset<span class="sc">$</span>type, </span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>                      <span class="at">position=</span>dataset<span class="sc">$</span>position, <span class="at">replicate=</span>dataset<span class="sc">$</span>rep, </span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>                      <span class="at">counts=</span>dataset <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;c_&quot;</span>)), </span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>                      <span class="at">metadata=</span>dataset <span class="sc">%&gt;%</span> <span class="fu">select</span>(wildtype, mutation, exp))</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="fu">head</span>(lilace_obj<span class="sc">$</span>data)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 13[39m
## [38;5;246m# Groups:   variant [2][39m
##   variant wildtype mutation exp   type    position rep     c_0   c_1   c_2   c_3
##   [3m[38;5;246m&lt;chr&gt;[39m[23m   [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m      [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m
## [38;5;250m1[39m p.(G2A) G        A        ph55  missenâ€¦        2 R1      118   146   215   260
## [38;5;250m2[39m p.(G2A) G        A        ph55  missenâ€¦        2 R2      146   108   127   284
## [38;5;250m3[39m p.(G2A) G        A        ph55  missenâ€¦        2 R3      144    55   106   134
## [38;5;250m4[39m p.(G2C) G        C        ph55  missenâ€¦        2 R1      148   101   384   507
## [38;5;250m5[39m p.(G2C) G        C        ph55  missenâ€¦        2 R2      203   201   307   616
## [38;5;250m6[39m p.(G2C) G        C        ph55  missenâ€¦        2 R3      236   175   262   547
## [38;5;246m# â„¹ 2 more variables: n_counts &lt;dbl&gt;, total_counts &lt;dbl&gt;[39m</code></pre>
<p>We also provide the functions <code>lilace_from_enrich()</code>,
which can load counts from enrich2â€™s output format, and
<code>lilace_from_files()</code>, which can load counts from separate
bin and replicate count files, but they may not generalize to all
dataset formats. See the end of this vignette for an example call of
each.</p>
</div>
<div id="normalize-to-cell-sorting-proportions" class="section level2">
<h2>Normalize to cell sorting proportions</h2>
<p>FACS gating is often set to contain equal proportions of the overall
cell fluorescence distribution, but differences in bin PCR amplification
can lead to the over and under representation of certain bins in the
read counts. If this is the case, the data can be normalized to the
sorting proportions using the <code>lilace_sorting_normalize()</code>
function, which takes in a Lilace object and the proportions to
normalize to.</p>
<div class="float">
<img src="/Users/jerome/DocuLocal/DMS/lilace/vignettes/gpr68_ph55_sort.png" style="width:60.0%"
alt="Example sort proportions." />
<div class="figcaption">Example sort proportions.</div>
</div>
<p>In this case the sort proportions donâ€™t add up to 1, but thatâ€™s okay,
they are scaled to add up to 1 internally.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># normalize to sorting proportions</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>GPR_FACS_trace_percent_55 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.2184</span>, <span class="fl">0.1972</span>, <span class="fl">0.1869</span>, <span class="fl">0.1236</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>lilace_obj <span class="ot">&lt;-</span> <span class="fu">lilace_sorting_normalize</span>(lilace_obj, GPR_FACS_trace_percent_55, <span class="at">rep_specific=</span>F)</span></code></pre></div>
<pre><code>## Warning in lilace_sorting_normalize(lilace_obj, GPR_FACS_trace_percent_55, :
## Sorting proportions sum up to 0.7261 instead of 1.</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">head</span>(lilace_obj<span class="sc">$</span>normalized_data)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 13[39m
## [38;5;246m# Groups:   variant [2][39m
##   variant wildtype mutation exp   type    position rep     c_0   c_1   c_2   c_3
##   [3m[38;5;246m&lt;chr&gt;[39m[23m   [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m      [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m
## [38;5;250m1[39m p.(G2A) G        A        ph55  missenâ€¦        2 R1      177   164   199   160
## [38;5;250m2[39m p.(G2A) G        A        ph55  missenâ€¦        2 R2      192   131   148   150
## [38;5;250m3[39m p.(G2A) G        A        ph55  missenâ€¦        2 R3      199    69    92    86
## [38;5;250m4[39m p.(G2C) G        C        ph55  missenâ€¦        2 R1      222   113   355   312
## [38;5;250m5[39m p.(G2C) G        C        ph55  missenâ€¦        2 R2      267   243   356   324
## [38;5;250m6[39m p.(G2C) G        C        ph55  missenâ€¦        2 R3      327   218   227   351
## [38;5;246m# â„¹ 2 more variables: n_counts &lt;dbl&gt;, total_counts &lt;dbl&gt;[39m</code></pre>
<p>If we wish to normalize to replicate-specific sorting proportions, we
can format it like the following. The replicate labels in the list (R1,
R2, R3) should correspond to the labels used in the Lilace input.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># normalize to sorting proportions</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>GPR_FACS_trace_percent_55 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">R1=</span><span class="fu">c</span>(<span class="fl">0.2184</span>, <span class="fl">0.1972</span>, <span class="fl">0.1869</span>, <span class="fl">0.1236</span>),</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>                                  <span class="at">R2=</span><span class="fu">c</span>(<span class="fl">0.2184</span>, <span class="fl">0.1972</span>, <span class="fl">0.1869</span>, <span class="fl">0.1236</span>),</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>                                  <span class="at">R3=</span><span class="fu">c</span>(<span class="fl">0.2184</span>, <span class="fl">0.1972</span>, <span class="fl">0.1869</span>, <span class="fl">0.1236</span>))</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>lilace_obj <span class="ot">&lt;-</span> <span class="fu">lilace_sorting_normalize</span>(lilace_obj, GPR_FACS_trace_percent_55, <span class="at">rep_specific=</span>T)</span></code></pre></div>
<pre><code>## Warning in lilace_sorting_normalize(lilace_obj, GPR_FACS_trace_percent_55, :
## Sorting proportions sum up to 0.7261 instead of 1.
## Warning in lilace_sorting_normalize(lilace_obj, GPR_FACS_trace_percent_55, :
## Sorting proportions sum up to 0.7261 instead of 1.
## Warning in lilace_sorting_normalize(lilace_obj, GPR_FACS_trace_percent_55, :
## Sorting proportions sum up to 0.7261 instead of 1.</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">head</span>(lilace_obj<span class="sc">$</span>normalized_data)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 13[39m
## [38;5;246m# Groups:   variant [2][39m
##   variant wildtype mutation exp   type    position rep     c_0   c_1   c_2   c_3
##   [3m[38;5;246m&lt;chr&gt;[39m[23m   [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m      [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m
## [38;5;250m1[39m p.(G2A) G        A        ph55  missenâ€¦        2 R1      177   164   199   160
## [38;5;250m2[39m p.(G2A) G        A        ph55  missenâ€¦        2 R2      192   131   148   150
## [38;5;250m3[39m p.(G2A) G        A        ph55  missenâ€¦        2 R3      199    69    92    86
## [38;5;250m4[39m p.(G2C) G        C        ph55  missenâ€¦        2 R1      222   113   355   312
## [38;5;250m5[39m p.(G2C) G        C        ph55  missenâ€¦        2 R2      267   243   356   324
## [38;5;250m6[39m p.(G2C) G        C        ph55  missenâ€¦        2 R3      327   218   227   351
## [38;5;246m# â„¹ 2 more variables: n_counts &lt;dbl&gt;, total_counts &lt;dbl&gt;[39m</code></pre>
</div>
<div id="run-lilace" class="section level2">
<h2>Run Lilace</h2>
<p>Once, we are ready to run Lilace, we first specify an output
directory where the output and model fitting logs will be saved.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="st">&quot;output&quot;</span></span></code></pre></div>
<p>Then, we use the function <code>lilace_fit_model()</code> to run the
main Lilace algorithm. This should only take a few minutes on this
truncated dataset, but usually takes a few hours on a full length
protein.</p>
<p>By default, the negative controls will be identified by variants
labeled as <code>synonymous</code> in the <code>lilace$data$type</code>
column. This can be changed by setting the <code>control_label</code>
argument to a different value in the column. To disable the negative
control-based bias correction, set <code>control_correction</code> to
<code>FALSE</code>. To disable position-level grouping, set
<code>use_positions</code> to <code>FALSE</code>. We provide example
outputs for both of these options towards the end of the vignette.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>lilace_obj <span class="ot">&lt;-</span> <span class="fu">lilace_fit_model</span>(lilace_obj, output_dir, <span class="at">control_label=</span><span class="st">&quot;synonymous&quot;</span>, </span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>                               <span class="at">control_correction=</span>T, <span class="at">use_positions=</span>T, <span class="at">pseudocount=</span>T,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>                               <span class="at">n_parallel_chains=</span><span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Running MCMC with 4 parallel chains...
## 
## Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 4 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 1 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 2 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 3 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 4 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 1 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 2 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 3 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 4 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 1 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 3 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 2 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 4 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 1 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 3 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 4 finished in 94.4 seconds.
## Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 1 finished in 96.8 seconds.
## Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 3 finished in 97.0 seconds.
## Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 2 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 2 finished in 137.8 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 106.5 seconds.
## Total execution time: 137.9 seconds.</code></pre>
<p>Once itâ€™s done running, Lilace saves the scores for each variant to
<code>output/lilace_output/variant_scores.tsv</code>. The scores
dataframe is also saved in <code>lilace_obj$scores</code>. The scores
are also combined with the input dataframe at
<code>lilace_obj$fitted_data</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>scores <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">&quot;output/lilace_output/variant_scores.tsv&quot;</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">head</span>(scores)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 12[39m
##   variant        type  wildtype mutation exp   position  effect effect_se   lfsr
##   [3m[38;5;246m&lt;chr&gt;[39m[23m          [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m     [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m
## [38;5;250m1[39m p.(G2del)      deleâ€¦ G        del0     ph55         2 -[31m0[39m[31m.[39m[31m0[39m[31m69[4m8[24m[39m     0.283 0.370 
## [38;5;250m2[39m p.(G2_N3del)   deleâ€¦ G        del1     ph55         2  0.345      0.280 0.095[4m5[24m
## [38;5;250m3[39m p.(G2_I4del)   deleâ€¦ G        del2     ph55         2  0.222      0.278 0.214 
## [38;5;250m4[39m p.(G2_N3insG)  inseâ€¦ G        ins0     ph55         2  0.273      0.278 0.159 
## [38;5;250m5[39m p.(G2_N3insGS) inseâ€¦ G        ins1     ph55         2  0.098[4m9[24m     0.273 0.366 
## [38;5;250m6[39m p.(G2A)        missâ€¦ G        A        ph55         2  0.111      0.282 0.356 
## [38;5;246m# â„¹ 3 more variables: pos_mean &lt;dbl&gt;, pos_sd &lt;dbl&gt;, discovery05 &lt;dbl&gt;[39m</code></pre>
<p>The <code>effect</code> column represents the estimated effect size /
score for a variant, while <code>effect_se</code> gives the standard
error. <code>lfsr</code> is the local false sign rate, which is a
Bayesian measure of significance analogous to a p-value. For example, a
default way to call discoveries would be to set a threshold of
<code>lfsr &lt; 0.05</code>. We encode this in the
<code>discovery05</code> column where a <code>-1</code> indicates a
significant leftward shift in fluorescence, <code>+1</code> a
significant rightward shift, and <code>0</code> is not significant.
<code>pos_mean</code> and <code>pos_sd</code> are the estimated
position-level mean and variance parametersâ€“these parameters are only
included in the final score table if Lilace was run with
<code>use_positions=T</code>.</p>
</div>
<div id="plot-results" class="section level2">
<h2>Plot results</h2>
<p>To analyze the output of the model, we can first plot the score
distributions of the different mutation types using
<code>lilace_score_density()</code> and ensure they align with
expectations.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">lilace_score_density</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;effect&quot;</span>, </span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>                     <span class="at">name=</span><span class="st">&quot;score_histogram&quot;</span>, <span class="at">hist=</span>T, <span class="at">scale.free=</span>T)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-13-1.png" width="700" /></p>
<p>We observe a substantial LOF mode for indels, a smaller one for
missense mutations, and a distribution around zero for synonymous
mutations.</p>
<p>Next, we plot the estimated scores on a heatmap.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">lilace_score_heatmap</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;effect&quot;</span>, <span class="at">name=</span><span class="st">&quot;score_heatmap&quot;</span>, </span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>                     <span class="at">x.text=</span><span class="dv">4</span>, <span class="at">seq.text=</span><span class="fl">1.5</span>, <span class="at">y.text=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-14-1.png" width="700" /></p>
<p>As well as the discoveries, at a threshold of
<code>lfsr &lt; 0.05</code>. Again, -1 indicates a significant leftward
shift in fluorescence, +1 a rightward shift, and 0 is not
significant.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="fu">lilace_score_heatmap</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;discovery05&quot;</span>, <span class="at">name=</span><span class="st">&quot;discovery05_heatmap&quot;</span>, </span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>                     <span class="at">x.text=</span><span class="dv">4</span>, <span class="at">seq.text=</span><span class="fl">1.5</span>, <span class="at">y.text=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-15-1.png" width="700" /></p>
<p>From here on, further analysis can be done, such as mapping to
protein structure and qualitatively analyzing the results.</p>
</div>
<div
id="example-runs-without-negative-control-correction-or-position-hierarchy"
class="section level2">
<h2>Example runs without negative control correction or position
hierarchy</h2>
<div id="without-the-negative-control-based-bias-correction"
class="section level4">
<h4>Without the negative control-based bias correction</h4>
<p>Without the negative control-based bias correction, the effect size
standard errors are smaller and more effects are called significant (at
the cost of more false positives). You may want to run this in cases
where variance in negative controls do not provide a good estimate of
experimental uncertainty (e.g.Â only a single WT variant), but you still
want Lilace scores for each variant. In this case, Lilace uncertainty
estimates (effect standard errors) do not incorporate any notion of
negative control variance, which may result in more false positives.
(note: a control label column is still required as a reference set to
score against)</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># specify outpur dir</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="st">&quot;output_no_nc_correction&quot;</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co"># run the model on data</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>fitted_data <span class="ot">&lt;-</span> <span class="fu">lilace_fit_model</span>(lilace_obj, output_dir, <span class="at">control_label=</span><span class="st">&quot;synonymous&quot;</span>, </span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>                                <span class="at">control_correction=</span>F)</span></code></pre></div>
<pre><code>## Warning in lilace_fit_model(lilace_obj, output_dir, control_label = &quot;synonymous&quot;, : Output directory output_no_nc_correction does not exist. Creating...</code></pre>
<pre><code>## Running MCMC with 4 parallel chains...
## 
## Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 2 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 4 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 1 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 3 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 4 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 3 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 2 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 1 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 4 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 2 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 1 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 3 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 4 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 2 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 1 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 4 finished in 94.5 seconds.
## Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 2 finished in 95.0 seconds.
## Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 1 finished in 97.6 seconds.
## Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 3 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 3 finished in 137.9 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 106.2 seconds.
## Total execution time: 138.1 seconds.</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># read scores file</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>scores <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">&quot;output_no_nc_correction/lilace_output/variant_scores.tsv&quot;</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(scores))</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 12[39m
##   variant       type  wildtype mutation exp   position  effect effect_se    lfsr
##   [3m[38;5;246m&lt;chr&gt;[39m[23m         [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m     [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m
## [38;5;250m1[39m p.(G2del)     deleâ€¦ G        del0     ph55         2 -[31m0[39m[31m.[39m[31m0[39m[31m63[4m8[24m[39m     0.125 0.307  
## [38;5;250m2[39m p.(G2_N3del)  deleâ€¦ G        del1     ph55         2  0.358      0.126 0.002[4m5[24m 
## [38;5;250m3[39m p.(G2_I4del)  deleâ€¦ G        del2     ph55         2  0.226      0.107 0.016[4m8[24m 
## [38;5;250m4[39m p.(G2_N3insG) inseâ€¦ G        ins0     ph55         2  0.282      0.112 0.006[4m7[24m[4m5[24m
## [38;5;250m5[39m p.(G2_N3insGâ€¦ inseâ€¦ G        ins1     ph55         2  0.106      0.103 0.152  
## [38;5;250m6[39m p.(G2A)       missâ€¦ G        A        ph55         2  0.110      0.119 0.174  
## [38;5;246m# â„¹ 3 more variables: pos_mean &lt;dbl&gt;, pos_sd &lt;dbl&gt;, discovery05 &lt;dbl&gt;[39m</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">lilace_score_heatmap</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;effect&quot;</span>, <span class="at">name=</span><span class="st">&quot;score_heatmap&quot;</span>, </span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>                     <span class="at">x.text=</span><span class="dv">4</span>, <span class="at">seq.text=</span><span class="fl">1.5</span>, <span class="at">y.text=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-16-1.png" width="700" /></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="fu">lilace_score_heatmap</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;discovery05&quot;</span>, <span class="at">name=</span><span class="st">&quot;discovery05_heatmap&quot;</span>, </span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>                     <span class="at">x.text=</span><span class="dv">4</span>, <span class="at">seq.text=</span><span class="fl">1.5</span>, <span class="at">y.text=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-16-2.png" width="700" /></p>
</div>
<div id="without-the-position-hierarchy" class="section level4">
<h4>Without the position hierarchy</h4>
<p>Without using position effects to inform variant effect estimates,
each effect size will be completely independent of the others at its
position. You may want to run this if the data has more than a single
residue mutation at a time or complete position independence is desired
for downstream analysis (e.g.Â clinical classification that uses multiple
effects at a position as a line of evidence).</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co"># specify outpur dir</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="st">&quot;output_nopos&quot;</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="co"># run the model on data</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>fitted_data <span class="ot">&lt;-</span> <span class="fu">lilace_fit_model</span>(lilace_obj, output_dir, <span class="at">control_label=</span><span class="st">&quot;synonymous&quot;</span>, </span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>                                <span class="at">use_positions=</span>F)</span></code></pre></div>
<pre><code>## Warning in lilace_fit_model(lilace_obj, output_dir, control_label = &quot;synonymous&quot;, : Output directory output_nopos does not exist. Creating...</code></pre>
<pre><code>## Running MCMC with 4 parallel chains...
## 
## Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
## Chain 3 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 4 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 2 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 1 Iteration:  250 / 2000 [ 12%]  (Warmup) 
## Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
## Chain 3 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 4 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 2 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 1 Iteration:  750 / 2000 [ 37%]  (Warmup) 
## Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
## Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
## Chain 3 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 4 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 2 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 1 Iteration: 1250 / 2000 [ 62%]  (Sampling) 
## Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
## Chain 3 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 4 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 2 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 1 Iteration: 1750 / 2000 [ 87%]  (Sampling) 
## Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 3 finished in 96.2 seconds.
## Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 4 finished in 97.1 seconds.
## Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 2 finished in 97.7 seconds.
## Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
## Chain 1 finished in 98.4 seconds.
## 
## All 4 chains finished successfully.
## Mean chain execution time: 97.3 seconds.
## Total execution time: 98.5 seconds.</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="co"># read scores file</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>scores <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">&quot;output_nopos/lilace_output/variant_scores.tsv&quot;</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(scores))</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 10[39m
##   variant        type  wildtype mutation exp   position  effect effect_se   lfsr
##   [3m[38;5;246m&lt;chr&gt;[39m[23m          [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;dbl&gt;[39m[23m   [3m[38;5;246m&lt;dbl&gt;[39m[23m     [3m[38;5;246m&lt;dbl&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m
## [38;5;250m1[39m p.(G2del)      deleâ€¦ G        del0     ph55         2 -[31m0[39m[31m.[39m[31m187[39m      0.290 0.235 
## [38;5;250m2[39m p.(G2_N3del)   deleâ€¦ G        del1     ph55         2  0.452      0.298 0.054[4m2[24m
## [38;5;250m3[39m p.(G2_I4del)   deleâ€¦ G        del2     ph55         2  0.245      0.293 0.195 
## [38;5;250m4[39m p.(G2_N3insG)  inseâ€¦ G        ins0     ph55         2  0.328      0.283 0.108 
## [38;5;250m5[39m p.(G2_N3insGS) inseâ€¦ G        ins1     ph55         2  0.084[4m9[24m     0.284 0.394 
## [38;5;250m6[39m p.(G2A)        missâ€¦ G        A        ph55         2  0.069[4m3[24m     0.288 0.424 
## [38;5;246m# â„¹ 1 more variable: discovery05 &lt;dbl&gt;[39m</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="fu">lilace_score_heatmap</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;effect&quot;</span>, <span class="at">name=</span><span class="st">&quot;score_heatmap&quot;</span>, </span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>                     <span class="at">x.text=</span><span class="dv">4</span>, <span class="at">seq.text=</span><span class="fl">1.5</span>, <span class="at">y.text=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-17-1.png" width="700" /></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="fu">lilace_score_heatmap</span>(scores, output_dir, <span class="at">score.col=</span><span class="st">&quot;discovery05&quot;</span>, <span class="at">name=</span><span class="st">&quot;discovery05_heatmap&quot;</span>, </span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>                     <span class="at">x.text=</span><span class="dv">4</span>, <span class="at">seq.text=</span><span class="fl">1.5</span>, <span class="at">y.text=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-17-2.png" width="700" /></p>
</div>
</div>
<div id="view-posterior-samples" class="section level2">
<h2>View posterior samples</h2>
<p>For convenience and advanced analysis, the posterior samples are
saved in <code>lilace_output/posterior_samples.RData</code>. They can be
analyzed further with the <code>posterior</code> package. Here is an
example of how to access them:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>draws <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;output/lilace_output/posterior_samples.RData&quot;</span>)</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>posterior_samples <span class="ot">&lt;-</span> posterior<span class="sc">::</span><span class="fu">as_draws_rvars</span>(draws)</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="fu">head</span>(posterior<span class="sc">::</span><span class="fu">draws_of</span>(posterior_samples<span class="sc">$</span>a))</span></code></pre></div>
<pre><code>##        [,1]       [,2]      [,3]
## 1 0.0130850 0.01033440 0.0219349
## 2 0.0118919 0.01305480 0.0219369
## 3 0.0161553 0.00783614 0.0250009
## 4 0.0177819 0.00515565 0.0211849
## 5 0.0206479 0.00637177 0.0244694
## 6 0.0221742 0.01094440 0.0206382</code></pre>
</div>
<div id="format-input-data-from-enrich2-output-format"
class="section level2">
<h2>Format input data from Enrich2 output format</h2>
<p>This function expects data in the following format created through
processing counts with Enrich2. <img src="/Users/jerome/DocuLocal/DMS/lilace/vignettes/enrich_format.png"
style="width:60.0%" alt="Enrich2 counts example format" /></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>enrich_file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;kir21_enrich_format.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>)</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>lilace_obj_from_enrich <span class="ot">&lt;-</span> <span class="fu">lilace_from_enrich</span>(enrich_file, <span class="at">pheno=</span><span class="st">&quot;abundance&quot;</span>) <span class="co"># filtering to just the abundance phenotype</span></span></code></pre></div>
<pre><code>## Formatting from enrich2 output. Synonymous mutations will be used for negative control-based bias correction. If this is not desirable, please input using the format_data() function.</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="fu">head</span>(lilace_obj_from_enrich<span class="sc">$</span>data)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 13[39m
## [38;5;246m# Groups:   variant [2][39m
##   variant  position wildtype mutation type     c_0   c_1   c_2   c_3 exp   rep  
##   [3m[38;5;246m&lt;chr&gt;[39m[23m       [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m  [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;dbl&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m
## [38;5;250m1[39m p.(A22A)       22 A        A        synonâ€¦   116   181   176   278 abunâ€¦ R1   
## [38;5;250m2[39m p.(A22A)       22 A        A        synonâ€¦   221   230   420   397 abunâ€¦ R2   
## [38;5;250m3[39m p.(A22A)       22 A        A        synonâ€¦    94   133   119   257 abunâ€¦ R4   
## [38;5;250m4[39m p.(A22A)       22 A        A        synonâ€¦   207   210   385   412 abunâ€¦ R5   
## [38;5;250m5[39m p.(A22C)       22 A        C        misseâ€¦    60   187    96   115 abunâ€¦ R1   
## [38;5;250m6[39m p.(A22C)       22 A        C        misseâ€¦   102   148   104    60 abunâ€¦ R2   
## [38;5;246m# â„¹ 2 more variables: n_counts &lt;dbl&gt;, total_counts &lt;dbl&gt;[39m</code></pre>
</div>
<div id="format-input-from-separate-gating-files"
class="section level2">
<h2>Format input from separate gating files</h2>
<p>Here, we provide an example of formatting from multiple input files
where the counts for each bin and replicate are in different files (such
as from the Dumpling processing pipeline). The counts will be joined by
shared column names, so each file must have at least a variant id
column, a position column, and a mutation type column. For example the
counts from bin 1 in replicate 1 could look like: <img
src="/Users/jerome/DocuLocal/DMS/lilace/vignettes/sep_file_counts.png" style="width:60.0%"
alt="Separate file counts example format" /></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="co"># input files in list format </span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="co"># (can add more replicates or bins--make sure they are in order from left to right)</span></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">R1=</span><span class="fu">list</span>(</span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R1_A.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>), <span class="co"># rep 1 bin 1</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R1_B.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>), <span class="co"># rep 1 bin 2</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R1_C.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>), <span class="co"># rep 1 bin 3</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R1_D.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>)  <span class="co"># rep 1 bin 4 </span></span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a>  ),</span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a>                  <span class="at">R2=</span><span class="fu">list</span>(</span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R2_A.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>), <span class="co"># rep 2 bin 1 </span></span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R2_B.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>), <span class="co"># rep 2 bin 2</span></span>
<span id="cb45-12"><a href="#cb45-12" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R2_C.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>), <span class="co"># rep 2 bin 3</span></span>
<span id="cb45-13"><a href="#cb45-13" tabindex="-1"></a>  <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;multi_input/R2_D.tsv&quot;</span>, <span class="at">package=</span><span class="st">&quot;lilace&quot;</span>)) <span class="co"># rep 2 bin 4</span></span>
<span id="cb45-14"><a href="#cb45-14" tabindex="-1"></a>  ) </span>
<span id="cb45-15"><a href="#cb45-15" tabindex="-1"></a>lilace_obj_from_multi_file <span class="ot">&lt;-</span> <span class="fu">lilace_from_files</span>(file_list, </span>
<span id="cb45-16"><a href="#cb45-16" tabindex="-1"></a>                                                <span class="at">variant_id_col=</span><span class="st">&quot;hgvs&quot;</span>,</span>
<span id="cb45-17"><a href="#cb45-17" tabindex="-1"></a>                                                <span class="at">position_col=</span><span class="st">&quot;position&quot;</span>,</span>
<span id="cb45-18"><a href="#cb45-18" tabindex="-1"></a>                                                <span class="at">mutation_type_col=</span><span class="st">&quot;type&quot;</span>,</span>
<span id="cb45-19"><a href="#cb45-19" tabindex="-1"></a>                                                <span class="at">count_col=</span><span class="st">&quot;count&quot;</span>, <span class="co"># column containing count is called count</span></span>
<span id="cb45-20"><a href="#cb45-20" tabindex="-1"></a>                                                <span class="at">delim=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>) </span>
<span id="cb45-21"><a href="#cb45-21" tabindex="-1"></a></span>
<span id="cb45-22"><a href="#cb45-22" tabindex="-1"></a><span class="fu">head</span>(lilace_obj_from_multi_file<span class="sc">$</span>data)</span></code></pre></div>
<pre><code>## [38;5;246m# A tibble: 6 Ã— 12[39m
## [38;5;246m# Groups:   variant [3][39m
##   variant wildtype mutation type     position rep     c_0   c_1   c_2   c_3
##   [3m[38;5;246m&lt;chr&gt;[39m[23m   [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m    [3m[38;5;246m&lt;chr&gt;[39m[23m       [3m[38;5;246m&lt;int&gt;[39m[23m [3m[38;5;246m&lt;chr&gt;[39m[23m [3m[38;5;246m&lt;int&gt;[39m[23m [3m[38;5;246m&lt;int&gt;[39m[23m [3m[38;5;246m&lt;int&gt;[39m[23m [3m[38;5;246m&lt;int&gt;[39m[23m
## [38;5;250m1[39m p.(G2A) G        A        missense        2 R1      118   146   215   260
## [38;5;250m2[39m p.(G2A) G        A        missense        2 R2      146   108   127   284
## [38;5;250m3[39m p.(G2C) G        C        missense        2 R1      148   101   384   507
## [38;5;250m4[39m p.(G2C) G        C        missense        2 R2      203   201   307   616
## [38;5;250m5[39m p.(G2D) G        D        missense        2 R1      201   185   212   328
## [38;5;250m6[39m p.(G2D) G        D        missense        2 R2      176   142   119   343
## [38;5;246m# â„¹ 2 more variables: n_counts &lt;int&gt;, total_counts &lt;int&gt;[39m</code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jerome Freudenberg.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>
